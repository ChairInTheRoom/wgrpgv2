<?php

include_once 'DialogConditionFactory.class';
include_once 'RPGNPC.class';
include_once 'RPGTime.class';

class DataGameUI{
	
	public function DataGameUI(){
		
		//load character
		if(isset($_POST['strCharacterName'])){
			$_SESSION['objRPGCharacter'] = new RPGCharacter($_POST['strCharacterName']);
		}
		
		$this->handleEvents();
		$this->handleTicks();
	}
	
	public function traverse($strDirection){
		// moves within current floor and generates a new event
		// when EventID is 1, standstill occurs, otherwise unique event happens
		$blnAllowedMove = $this->isAllowedMove($strDirection);
		if($blnAllowedMove){
			$objFloor = new RPGFloor($_SESSION['objRPGCharacter']->getFloor());
			$objFloor->setApplicableEvents($_SESSION['objRPGCharacter']->getRPGCharacterID());
			$intEventID = $objFloor->generateRandomEvent();
		}
		else{
			$intEventID = 1;
		}
		$_SESSION['objRPGCharacter']->setEventID($intEventID);		
		$_SESSION['objRPGCharacter']->setEventNodeID(0);
	}
	
	public function isAllowedMove($strDirection){
		if($strDirection == 'north'){
			return 1;
		}
		else if($strDirection == 'south'){
			return 1;
		}
		else if($strDirection == 'east'){
			return 1;
		}
		else if($strDirection == 'west'){
			return 1;
		}
		else{
			return 0;
		}
	}
	
	public function handleEvents(){
		if(isset($_GET['direction'])){
			$this->traverse($_GET['direction']);
		}
		
		if($_SESSION['objRPGCharacter']->getCombat() != 0){
			$_SESSION['objUISettings']->setEventFrame('Combat');
			$_SESSION['objUISettings']->setCommandsFrame('Combat');
			if(!isset($_SESSION['objEnemy'])){
				$_SESSION['objEnemy'] = new RPGNPC($_SESSION['objRPGCharacter']->getCombat());
				$_SESSION['strCombatMessage'] = "<b>Attack In Progress : " . $_SESSION['objEnemy']->getNPCName() . "</b><br/>";
			}
		}
		else{
			unset($_SESSION['objEnemy']);
			$_SESSION['objUISettings']->setEventFrame('Event');
			$_SESSION['objUISettings']->setCommandsFrame('Event');
		}
		
		$_SESSION['objRPGCharacter']->checkEndOfEvent();
		
		if(isset($_POST['itemAction']) && isset($_POST['itemID'])){
			if($_POST['itemAction'] == 'use'){
				$_SESSION['objRPGCharacter']->eatItem($_POST['itemID'], $_POST['itemHPHeal']);
			}
			elseif($_POST['itemAction'] == 'drop'){
				$_SESSION['objRPGCharacter']->dropItem($_POST['itemID']);
			}
			elseif($_POST['itemAction'] == 'equip'){
				$strEquipFunction = 'equip' . $_POST['itemType'];
				$_SESSION['objRPGCharacter']->$strEquipFunction($_POST['itemID']);
			}
			elseif($_POST['itemAction'] == 'unequip'){
				$_SESSION['objRPGCharacter']->unequipItem($_POST['itemID']);
			}
		}
	}
	
	public function handleTicks(){
		$_SESSION['objRPGCharacter']->setTime(RPGTime::addTickToTime($_SESSION['objRPGCharacter']->getTime()));
		$_SESSION['objRPGCharacter']->digestItems();
		$_SESSION['objRPGCharacter']->save();
	}	
}

?>